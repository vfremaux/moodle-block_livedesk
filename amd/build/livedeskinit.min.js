/**
 * Javascript controller for controlling the sections.
 *
 * @module     block_livedesk/notification
 * @package    blocks
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_livedesk/livedeskinit",["jquery","core/config","core/str","core/log"],(function($,cfg,str,log){var livedesk={dhxWins:"",selectedRow:0,menu:null,toolbar:null,mygrid:null,init:function(params){var url;livedesk.dhxWins=new dhtmlXWindows,livedesk.selectedRow=null,livedesk.params=params,livedesk.strs=[];str.get_strings([{key:"reply",component:"block_livedesk"},{key:"discard",component:"block_livedesk"},{key:"discardbefore",component:"block_livedesk"},{key:"emailuser",component:"block_livedesk"},{key:"message",component:"block_livedesk"},{key:"user",component:"block_livedesk"},{key:"messagetime",component:"block_livedesk"},{key:"origin",component:"block_livedesk"},{key:"lockedby",component:"block_livedesk"},{key:"livequeue",component:"block_livedesk"},{key:"livedeskinfo",component:"block_livedesk"},{key:"onlineusers",component:"block_livedesk"},{key:"monitoredplugins",component:"block_livedesk"},{key:"refreshposts",component:"block_livedesk"},{key:"onlineuserscount",component:"block_livedesk"},{key:"onlineattenderscount",component:"block_livedesk"},{key:"showhideanswered",component:"block_livedesk"},{key:"showhidediscarded",component:"block_livedesk"},{key:"showhidelocked",component:"block_livedesk"},{key:"configurations",component:"block_livedesk"},{key:"statistics",component:"block_livedesk"},{key:"managelivedesks",component:"block_livedesk"}]).done((function(s){livedesk.strs=s,log.debug(JSON.stringify(livedesk.strs)),log.debug(JSON.stringify(params)),log.debug("Start Livedesk construction"),livedesk.menu=new dhtmlXMenuObject,livedesk.menu.setIconsPath("pix/"),livedesk.menu.setSkin("dhx_web"),livedesk.menu.renderAsContextMenu(),livedesk.menu.addNewChild(null,1,"reply_post",livedesk.strs[0],!1,"reply_mail.png"),livedesk.menu.addNewChild(null,2,"discard_post",livedesk.strs[1],!1,"discard_mail.png"),livedesk.menu.addNewChild(null,3,"discard_posts_before",livedesk.strs[2],!1,"discard_mail.png"),livedesk.menu.addNewChild(null,4,"send_email",livedesk.strs[3],!1,"mail.png"),livedesk.menu.attachEvent("onClick",livedesk.onContextMenuClick),log.debug("Start Grid construction"),livedesk.mygrid=new dhtmlXGridObject("livedesk-postsgrid"),livedesk.mygrid.setImagePath("js/dhtmlx/3.0/dhtmlxGrid/codebase/imgs/");var headers="#,,"+livedesk.strs[4]+","+livedesk.strs[5];headers+=","+livedesk.strs[6]+","+livedesk.strs[7]+","+livedesk.strs[8],livedesk.mygrid.setHeader(headers),livedesk.mygrid.setInitWidths("30,40,320,100,150,200,*"),livedesk.mygrid.setColAlign("right,left,left,left,left,left,left"),livedesk.mygrid.setColTypes("ro,ro,ro,ro,ro,ro,ro"),livedesk.mygrid.setColSorting("int,str,str,str,str,str,str"),livedesk.mygrid.init(),livedesk.mygrid.setSkin("dhx_web"),livedesk.mygrid.enableContextMenu(livedesk.menu),log.debug("Loading posts"),url=cfg.wwwroot+"/blocks/livedesk/ajax/service.php?",url+="action=load_liveentries&",url+="bid="+livedesk.params.bid,livedesk.mygrid.load(url,"xml"),livedesk.mygrid.attachEvent("onBeforeContextMenu",livedesk.onBeforeContextMenuHandler),livedesk.mygrid.attachEvent("onRowDblClicked",livedesk.onRowDblClicked),livedesk.mygrid.attachEvent("onBeforeContextMenu",livedesk.onBeforeContextMenu),log.debug("Creating layout");var layout=new dhtmlXLayoutObject("livedesk-masterlayout","4C");layout.setSkin("dhx_web"),layout.cells("a").setWidth("800"),layout.cells("a").setHeight(800),layout.cells("b").setWidth("250"),layout.cells("c").setWidth("250"),layout.cells("d").setWidth("250"),layout.cells("b").setHeight("90"),layout.cells("c").setHeight(130),layout.cells("a").attachObject("livedesk-postsgrid"),layout.cells("c").attachObject("livedesk-onlineuserscount"),layout.cells("b").attachObject("livedesk-info"),layout.cells("d").attachObject("livedesk-plugins"),layout.cells("a").setText(livedesk.strs[9]),layout.cells("b").setText(livedesk.strs[10]),layout.cells("c").setText(livedesk.strs[11]),layout.cells("d").setText(livedesk.strs[12]),log.debug("Creating toolbar");var toolbar=layout.attachToolbar();toolbar.setIconsPath("pix/"),toolbar.setSkin("dhx_web"),toolbar.addButton("posts_refresh",2,livedesk.strs[13],"refresh.png");var bti=3;livedesk.params.canviewsettings&&(toolbar.addButton("settings",bti,livedesk.strs[19],"settings.png",null),bti++),livedesk.params.canviewstats&&(toolbar.addButton("view_statistics",bti,livedesk.strs[20],"statistics.png",null),bti++),livedesk.params.canmanage&&(toolbar.addButton("manage_livedesks",bti,livedesk.strs[21],"manage.png",null),bti++),toolbar.addButtonTwoState("show_answered",bti,"","show_answered_on.png","show_answered_off.png"),bti++,toolbar.setItemToolTip("show_answered",livedesk.strs[16]),livedesk.params.show_answered?(toolbar.setItemState("show_answered",!0),toolbar.setItemImage("show_answered","show_answered_on.png")):(toolbar.setItemState("show_answered",!1),toolbar.setItemImage("show_answered","show_answered_off.png")),toolbar.addButtonTwoState("show_discarded",bti,"","show_discarded_on.png","show_discarded_off.png"),bti++,toolbar.setItemToolTip("show_discarded",livedesk.strs[17]),livedesk.params.show_discarded?(toolbar.setItemState("show_discarded",!0),toolbar.setItemImage("show_discarded","show_discarded_on.png")):(toolbar.setItemState("show_discarded",!1),toolbar.setItemImage("show_discarded","show_discarded_off.png")),toolbar.addButtonTwoState("show_locked",bti,"","show_locked_on.png","show_locked_off.png"),bti++,toolbar.setItemToolTip("show_locked",livedesk.strs[18]),livedesk.params.show_locked?(toolbar.setItemState("show_locked",!0),toolbar.setItemImage("show_locked","show_locked_on.png")):(toolbar.setItemState("show_locked",!1),toolbar.setItemImage("show_locked","show_locked_off.png")),toolbar.attachEvent("onClick",livedesk.toolbarClickHandler),toolbar.attachEvent("onStateChange",livedesk.toolbarStateChange),livedesk.toolbar=toolbar,livedesk.getMonitoredPlugins(),livedesk.refreshOnlineUsersCount(),livedesk.params.refresh>0&&(log.debug("Installing livedesk updater"),setInterval((function(){livedesk.refreshGrid(),livedesk.refreshOnlineUsersCount()}),livedesk.params.refresh)),livedesk.params.keepalive>0&&(log.debug("Installing livedesk keepalive signal"),setInterval((function(){livedesk.keepMeAlive()}),livedesk.params.keepalive)),$(".noty_message").bind("click",(function(){$(this).find(".noty_message_num").val()})),log.debug("Block Livedesk AMD initialized")}))},onBeforeContextMenu:function(id){return livedesk.selectedRow=id,!0},onContextMenuClick:function(id){var selId;switch(id){case"reply_post":return selId=livedesk.selectedRow,livedesk.reply_post(selId),!0;case"discard_post":livedesk.discard_post(livedesk.selectedRow);break;case"discard_posts_before":var timecreated=livedesk.mygrid.getUserData(livedesk.selectedRow,"timecreated");livedesk.dhxWins.createWindow("discard_messages",400,100,400,130),livedesk.dhxWins.window("discard_messages").setModal(!0);var discardiconurl=cfg.wwwroot+"/blocks/livedesk/pix/discard_mail.png";livedesk.dhxWins.window("discard_messages").setIcon(discardiconurl),livedesk.dhxWins.window("discard_messages").setText(livedesk.strs[2]);var url=cfg.wwwroot+"/blocks/livedesk/discard_messages_before.php?";return url+="bid="+livedesk.params.bid+"&",url+="date="+timecreated,livedesk.dhxWins.window("discard_messages").attachURL(url,!0),!0}},onBeforeContextMenuHandler:function(id){return 0==livedesk.mygrid.getUserData(id,"status_id")?(livedesk.menu.hideItem("disable_post"),livedesk.menu.showItem("enable_post")):(livedesk.menu.hideItem("enable_post"),livedesk.menu.showItem("disable_post")),!0},toolbarClickHandler:function(item){var url;switch(item){case"posts_refresh":livedesk.refreshGrid();break;case"view_statistics":var win=livedesk.dhxWins.createWindow("view_statistics",400,100,850,400);win.setModal(!0);var statsiconurl=cfg.wwwroot+"/blocks/livedesk/pix/statistics.png";win.setIcon(statsiconurl),win.setText("Statistics");var statsurl=cfg.wwwroot+"/blocks/livedesk/statistics.php?";return statsurl+="bid="+livedesk.params.bid,win.attachURL(statsurl,!0),!0;case"settings":return url=cfg.wwwroot+"/course/view.php?",url+="id="+livedesk.params.courseid,url+="&bui_editid="+livedesk.params.bid,url+="&sesskey="+cfg.sesskey,window.location=url,!0;case"manage_livedesks":return url=cfg.wwwroot+"/blocks/livedesk/manage.php",window.location=url,!0}},toolbarStateChange:function(item,state){state?livedesk.toolbar.setItemImage(item,item+"_on.png"):livedesk.toolbar.setItemImage(item,item+"_off.png");var url=cfg.wwwroot+"/blocks/livedesk/ajax/service.php?";return url+="action=change_state&",url+="item="+item+"&",url+="state="+state+"&",url+="bid="+livedesk.params.bid,$.post(url,(function(){})),livedesk.refreshGrid(),!0},refreshGrid:function(){var url=cfg.wwwroot+"/blocks/livedesk/ajax/service.php?";return url+="action=load_liveentries&",url+="bid="+livedesk.params.bid,_isIE?livedesk.mygrid.clearAndLoad(url,"xml"):$.post(url,(function(data){livedesk.mygrid.clearAll(),livedesk.mygrid.parse(data)})),!0},onRowDblClicked:function(rId){livedesk.reply_post(rId)},reply_post:function(rowId){var itemid=livedesk.mygrid.getUserData(rowId,"itemid"),messageid=livedesk.mygrid.getUserData(rowId,"messageid"),cmid=livedesk.mygrid.getUserData(rowId,"cmid"),randX=Math.floor(101*Math.random())+350,randY=Math.floor(101*Math.random())+50,win=livedesk.dhxWins.createWindow("reply_post"+rowId,randX,randY,800,450);win.messageid=messageid,win.closing=!1,win.setModal(!1),win.setText("Reply"),win.attachURL("reply.php?reply="+itemid+"&cmid="+cmid,!1),livedesk.dhxWins.attachEvent("onClose",livedesk.unlockItem)},generateNoty:function(text,type){return noty({text:text,timeout:5e3,closeWith:["button"],type:type,dismissQueue:!0,layout:"bottomRight",theme:"defaultTheme"})},refreshOnlineUsersCount:function(){var url=cfg.wwwroot+"/blocks/livedesk/ajax/service.php?";url+="action=get_online_users_count&",url+="bid="+livedesk.params.bid,$.post(url,(function(data){data=JSON.parse(data);var htmlbuffer='<div class="online_users">';if(htmlbuffer+='<img src="pix/user.png" /> ',htmlbuffer+=livedesk.strs[14]+" : "+data.users_count,htmlbuffer+="</div>",$("#livedesk-onlineuserscont").html(htmlbuffer),htmlbuffer='<div class="online_users">',htmlbuffer+='<img src="pix/user-black.png" /> ',htmlbuffer+=livedesk.strs[15]+" : "+data.attenders_count,htmlbuffer+="</div>",$("#livedesk-onlineuserscount").append(htmlbuffer),data.attenders_count>0){for(var userlist='<ul class="livedesk-userlist">',i=0;i<data.attenders.length;i++)userlist+='<li class="online_users '+data.attenders[i].className+'">',userlist+=data.attenders[i].name,userlist+="</li>";$("#livedesk-onlineuserscount").append(userlist+"</ul>")}}))},keepMeAlive:function(){var url=cfg.wwwroot+"/blocks/livedesk/ajax/service.php?";url+="action=keep_me_live&",url+="bid="+livedesk.params.bid+"&",url+="livedeskid="+livedesk.params.livedeskid+"&",url+="courseid="+livedesk.params.courseid,$.post(url,(function(data){$("#livedesk-onlineuserscount").html(livedesk.strs[11]+data)}))},getMonitoredPlugins:function(){var url=cfg.wwwroot+"/blocks/livedesk/ajax/service.php?";url+="action=get_monitored_plugins&",url+="livedeskid="+livedesk.params.livedeskid+"&",url+="bid="+livedesk.params.bid,$.post(url,(function(data){data=JSON.parse(data),$("#livedesk-plugins").html("");var htmlbuffer,blockpixurl=cfg.wwwroot+"/blocks/livedesk/pix/block.png";for(var key in data){htmlbuffer='<div class="online_users">',htmlbuffer+='<img src="'+blockpixurl+'" />',htmlbuffer+='<a target="_blank" href="'+(cfg.wwwroot+"/mod/forum/view.php?id="+data[key].cmid)+'" > ',htmlbuffer+=data[key].name,htmlbuffer+="</a>",htmlbuffer+="</div>",$("#livedesk-plugins").append(htmlbuffer)}}))},unlockItem:function(win){if(!win.closing){win.closing=!0;var url=cfg.wwwroot+"/blocks/livedesk/ajax/service.php?";url+="action=unlock_item&",url+="bid="+livedesk.params.bid+"&",url+="livedeskid="+livedesk.params.livedeskid+"&",url+="courseid="+livedesk.params.courseid+"&",url+="messageid="+win.messageid,$.post(url,(function(){livedesk.refreshGrid()}))}return!0},discard_post:function(){var postid=livedesk.mygrid.getUserData(livedesk.selectedRow,"messageid"),url=cfg.wwwroot+"/blocks/livedesk/ajax/service.php?";url+="action=discard_post&",url+="bid="+livedesk.params.bid+"&",url+="livedeskid="+livedesk.params.livedeskid+"&",url+="courseid="+livedesk.params.courseid+"&",url+="messageid="+postid,$.post(url,(function(){livedesk.refreshGrid()}))}};return livedesk}));

//# sourceMappingURL=livedeskinit.min.js.map