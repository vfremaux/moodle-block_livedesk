define(["jquery","core/config","core/str","core/log"],function(a,b,c,d){var e={dhxWins:"",selectedRow:0,menu:null,toolbar:null,mygrid:null,init:function(f){var g;e.dhxWins=new dhtmlXWindows,e.selectedRow=null,e.params=f,e.strs=[];var h=[{key:"reply",component:"block_livedesk"},{key:"discard",component:"block_livedesk"},{key:"discardbefore",component:"block_livedesk"},{key:"emailuser",component:"block_livedesk"},{key:"message",component:"block_livedesk"},{key:"user",component:"block_livedesk"},{key:"messagetime",component:"block_livedesk"},{key:"origin",component:"block_livedesk"},{key:"lockedby",component:"block_livedesk"},{key:"livequeue",component:"block_livedesk"},{key:"livedeskinfo",component:"block_livedesk"},{key:"onlineusers",component:"block_livedesk"},{key:"monitoredplugins",component:"block_livedesk"},{key:"refreshposts",component:"block_livedesk"},{key:"onlineuserscount",component:"block_livedesk"},{key:"onlineattenderscount",component:"block_livedesk"},{key:"showhideanswered",component:"block_livedesk"},{key:"showhidediscarded",component:"block_livedesk"},{key:"showhidelocked",component:"block_livedesk"},{key:"configurations",component:"block_livedesk"},{key:"statistics",component:"block_livedesk"},{key:"managelivedesks",component:"block_livedesk"}];c.get_strings(h).done(function(c){e.strs=c,d.debug(JSON.stringify(e.strs)),d.debug(JSON.stringify(f)),d.debug("Start Livedesk construction"),e.menu=new dhtmlXMenuObject,e.menu.setIconsPath("pix/"),e.menu.setSkin("dhx_web"),e.menu.renderAsContextMenu(),e.menu.addNewChild(null,1,"reply_post",e.strs[0],!1,"reply_mail.png"),e.menu.addNewChild(null,2,"discard_post",e.strs[1],!1,"discard_mail.png"),e.menu.addNewChild(null,3,"discard_posts_before",e.strs[2],!1,"discard_mail.png"),e.menu.addNewChild(null,4,"send_email",e.strs[3],!1,"mail.png"),e.menu.attachEvent("onClick",e.onContextMenuClick),d.debug("Start Grid construction"),e.mygrid=new dhtmlXGridObject("livedesk-postsgrid"),e.mygrid.setImagePath("js/dhtmlx/3.0/dhtmlxGrid/codebase/imgs/");var h="#,,"+e.strs[4]+","+e.strs[5];h+=","+e.strs[6]+","+e.strs[7]+","+e.strs[8],e.mygrid.setHeader(h),e.mygrid.setInitWidths("30,40,320,100,150,200,*"),e.mygrid.setColAlign("right,left,left,left,left,left,left"),e.mygrid.setColTypes("ro,ro,ro,ro,ro,ro,ro"),e.mygrid.setColSorting("int,str,str,str,str,str,str"),e.mygrid.init(),e.mygrid.setSkin("dhx_web"),e.mygrid.enableContextMenu(e.menu),d.debug("Loading posts"),g=b.wwwroot+"/blocks/livedesk/ajax/service.php?",g+="action=load_liveentries&",g+="bid="+e.params.bid,e.mygrid.load(g,"xml"),e.mygrid.attachEvent("onBeforeContextMenu",e.onBeforeContextMenuHandler),e.mygrid.attachEvent("onRowDblClicked",e.onRowDblClicked),e.mygrid.attachEvent("onBeforeContextMenu",e.onBeforeContextMenu),d.debug("Creating layout");var i=new dhtmlXLayoutObject("livedesk-masterlayout","4C");i.setSkin("dhx_web"),i.cells("a").setWidth("800"),i.cells("a").setHeight(800),i.cells("b").setWidth("250"),i.cells("c").setWidth("250"),i.cells("d").setWidth("250"),i.cells("b").setHeight("90"),i.cells("c").setHeight(130),i.cells("a").attachObject("livedesk-postsgrid"),i.cells("c").attachObject("livedesk-onlineuserscount"),i.cells("b").attachObject("livedesk-info"),i.cells("d").attachObject("livedesk-plugins"),i.cells("a").setText(e.strs[9]),i.cells("b").setText(e.strs[10]),i.cells("c").setText(e.strs[11]),i.cells("d").setText(e.strs[12]),d.debug("Creating toolbar");var j=i.attachToolbar();j.setIconsPath("pix/"),j.setSkin("dhx_web"),j.addButton("posts_refresh",2,e.strs[13],"refresh.png");var k=3;e.params.canviewsettings&&(j.addButton("settings",k,e.strs[19],"settings.png",null),k++),e.params.canviewstats&&(j.addButton("view_statistics",k,e.strs[20],"statistics.png",null),k++),e.params.canmanage&&(j.addButton("manage_livedesks",k,e.strs[21],"manage.png",null),k++),j.addButtonTwoState("show_answered",k,"","show_answered_on.png","show_answered_off.png"),k++,j.setItemToolTip("show_answered",e.strs[16]),e.params.show_answered?(j.setItemState("show_answered",!0),j.setItemImage("show_answered","show_answered_on.png")):(j.setItemState("show_answered",!1),j.setItemImage("show_answered","show_answered_off.png")),j.addButtonTwoState("show_discarded",k,"","show_discarded_on.png","show_discarded_off.png"),k++,j.setItemToolTip("show_discarded",e.strs[17]),e.params.show_discarded?(j.setItemState("show_discarded",!0),j.setItemImage("show_discarded","show_discarded_on.png")):(j.setItemState("show_discarded",!1),j.setItemImage("show_discarded","show_discarded_off.png")),j.addButtonTwoState("show_locked",k,"","show_locked_on.png","show_locked_off.png"),k++,j.setItemToolTip("show_locked",e.strs[18]),e.params.show_locked?(j.setItemState("show_locked",!0),j.setItemImage("show_locked","show_locked_on.png")):(j.setItemState("show_locked",!1),j.setItemImage("show_locked","show_locked_off.png")),j.attachEvent("onClick",e.toolbarClickHandler),j.attachEvent("onStateChange",e.toolbarStateChange),e.toolbar=j,e.getMonitoredPlugins(),e.refreshOnlineUsersCount(),e.params.refresh>0&&(d.debug("Installing livedesk updater"),setInterval(function(){e.refreshGrid(),e.refreshOnlineUsersCount()},e.params.refresh)),e.params.keepalive>0&&(d.debug("Installing livedesk keepalive signal"),setInterval(function(){e.keepMeAlive()},e.params.keepalive)),a(".noty_message").bind("click",function(){var b=a(this).find(".noty_message_num").val()}),d.debug("Block Livedesk AMD initialized")})},onBeforeContextMenu:function(a){return e.selectedRow=a,!0},onContextMenuClick:function(a){var c;switch(a){case"reply_post":return c=e.selectedRow,e.reply_post(c),!0;case"discard_post":e.discard_post(e.selectedRow);break;case"discard_posts_before":var d=e.mygrid.getUserData(e.selectedRow,"timecreated");e.dhxWins.createWindow("discard_messages",400,100,400,130),e.dhxWins.window("discard_messages").setModal(!0);var f=b.wwwroot+"/blocks/livedesk/pix/discard_mail.png";e.dhxWins.window("discard_messages").setIcon(f),e.dhxWins.window("discard_messages").setText(e.strs[2]);var g=b.wwwroot+"/blocks/livedesk/discard_messages_before.php?";return g+="bid="+e.params.bid+"&",g+="date="+d,e.dhxWins.window("discard_messages").attachURL(g,!0),!0}},onBeforeContextMenuHandler:function(a){var b=e.mygrid.getUserData(a,"status_id");return 0==b?(e.menu.hideItem("disable_post"),e.menu.showItem("enable_post")):(e.menu.hideItem("enable_post"),e.menu.showItem("disable_post")),!0},toolbarClickHandler:function(a){var c;switch(a){case"posts_refresh":e.refreshGrid();break;case"view_statistics":var d=e.dhxWins.createWindow("view_statistics",400,100,850,400);d.setModal(!0);var f=b.wwwroot+"/blocks/livedesk/pix/statistics.png";d.setIcon(f),d.setText("Statistics");var g=b.wwwroot+"/blocks/livedesk/statistics.php?";return g+="bid="+e.params.bid,d.attachURL(g,!0),!0;case"settings":return c=b.wwwroot+"/course/view.php?",c+="id="+e.params.courseid,c+="&bui_editid="+e.params.bid,c+="&sesskey="+b.sesskey,window.location=c,!0;case"manage_livedesks":return c=b.wwwroot+"/blocks/livedesk/manage.php",window.location=c,!0}},toolbarStateChange:function(c,d){d?e.toolbar.setItemImage(c,c+"_on.png"):e.toolbar.setItemImage(c,c+"_off.png");var f=b.wwwroot+"/blocks/livedesk/ajax/service.php?";return f+="action=change_state&",f+="item="+c+"&",f+="state="+d+"&",f+="bid="+e.params.bid,a.post(f,function(){}),e.refreshGrid(),!0},refreshGrid:function(){var c=b.wwwroot+"/blocks/livedesk/ajax/service.php?";return c+="action=load_liveentries&",c+="bid="+e.params.bid,_isIE?e.mygrid.clearAndLoad(c,"xml"):a.post(c,function(a){e.mygrid.clearAll(),e.mygrid.parse(a)}),!0},onRowDblClicked:function(a){e.reply_post(a)},reply_post:function(a){var b=e.mygrid.getUserData(a,"itemid"),c=e.mygrid.getUserData(a,"messageid"),d=e.mygrid.getUserData(a,"cmid"),f=Math.floor(101*Math.random())+350,g=Math.floor(101*Math.random())+50,h=e.dhxWins.createWindow("reply_post"+a,f,g,800,450);h.messageid=c,h.closing=!1,h.setModal(!1),h.setText("Reply"),h.attachURL("reply.php?reply="+b+"&cmid="+d,!1),e.dhxWins.attachEvent("onClose",e.unlockItem)},generateNoty:function(a,b){var c=noty({text:a,timeout:5e3,closeWith:["button"],type:b,dismissQueue:!0,layout:"bottomRight",theme:"defaultTheme"});return c},refreshOnlineUsersCount:function(){var c=b.wwwroot+"/blocks/livedesk/ajax/service.php?";c+="action=get_online_users_count&",c+="bid="+e.params.bid,a.post(c,function(b){b=JSON.parse(b);var c='<div class="online_users">';if(c+='<img src="pix/user.png" /> ',c+=e.strs[14]+" : "+b.users_count,c+="</div>",a("#livedesk-onlineuserscont").html(c),c='<div class="online_users">',c+='<img src="pix/user-black.png" /> ',c+=e.strs[15]+" : "+b.attenders_count,c+="</div>",a("#livedesk-onlineuserscount").append(c),b.attenders_count>0){for(var d='<ul class="livedesk-userlist">',f=0;f<b.attenders.length;f++)d+='<li class="online_users '+b.attenders[f].className+'">',d+=b.attenders[f].name,d+="</li>";a("#livedesk-onlineuserscount").append(d+"</ul>")}})},keepMeAlive:function(){var c=b.wwwroot+"/blocks/livedesk/ajax/service.php?";c+="action=keep_me_live&",c+="bid="+e.params.bid+"&",c+="livedeskid="+e.params.livedeskid+"&",c+="courseid="+e.params.courseid,a.post(c,function(b){a("#livedesk-onlineuserscount").html(e.strs[11]+b)})},getMonitoredPlugins:function(){var c=b.wwwroot+"/blocks/livedesk/ajax/service.php?";c+="action=get_monitored_plugins&",c+="livedeskid="+e.params.livedeskid+"&",c+="bid="+e.params.bid,a.post(c,function(c){c=JSON.parse(c),a("#livedesk-plugins").html("");var d,e=b.wwwroot+"/blocks/livedesk/pix/block.png";for(var f in c){d='<div class="online_users">',d+='<img src="'+e+'" />';var g=b.wwwroot+"/mod/forum/view.php?id="+c[f].cmid;d+='<a target="_blank" href="'+g+'" > ',d+=c[f].name,d+="</a>",d+="</div>",a("#livedesk-plugins").append(d)}})},unlockItem:function(c){if(!c.closing){c.closing=!0;var d=b.wwwroot+"/blocks/livedesk/ajax/service.php?";d+="action=unlock_item&",d+="bid="+e.params.bid+"&",d+="livedeskid="+e.params.livedeskid+"&",d+="courseid="+e.params.courseid+"&",d+="messageid="+c.messageid,a.post(d,function(){e.refreshGrid()})}return!0},discard_post:function(){var c=e.mygrid.getUserData(e.selectedRow,"messageid"),d=b.wwwroot+"/blocks/livedesk/ajax/service.php?";d+="action=discard_post&",d+="bid="+e.params.bid+"&",d+="livedeskid="+e.params.livedeskid+"&",d+="courseid="+e.params.courseid+"&",d+="messageid="+c,a.post(d,function(){e.refreshGrid()})}};return e});